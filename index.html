<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sachin's Messenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        #app-interface { display: flex; width: 100vw; height: 100dvh; overflow: hidden; }
        .sidebar-pane { width: 320px; flex-shrink: 0; display: flex; flex-direction: column; background: #111827; }
        .chat-pane { flex-grow: 1; display: flex; flex-direction: column; background: #020617; transition: transform 0.3s ease-in-out; }

        @media (max-width: 768px) {
            .sidebar-pane { width: 100vw; }
            .chat-pane { position: fixed; inset: 0; width: 100vw; transform: translateX(100%); z-index: 50; }
            .chat-pane.active { transform: translateX(0); }
        }

        .bubble-me { border-bottom-right-radius: 4px !important; background: #2563eb; color: white; }
        .bubble-other { border-bottom-left-radius: 4px !important; background: rgba(30, 41, 59, 0.8); color: #e2e8f0; }
    </style>
</head>
<body class="bg-[#0f172a] text-slate-200 h-screen overflow-hidden">

    <div id="identity-popup" class="hidden fixed inset-0 bg-black/95 flex items-center justify-center z-[100] p-4">
        <div class="glass p-8 rounded-3xl w-full max-w-sm shadow-2xl">
            <h2 class="text-xl font-bold mb-6 text-blue-400">Profile Setup</h2>
            <input id="reg-name" type="text" placeholder="Name" class="w-full p-4 mb-3 bg-slate-800 rounded-2xl outline-none border border-slate-700">
            <div class="flex gap-2 mb-3">
                <button onclick="setRegGender('male')" id="btn-male" class="flex-1 py-3 rounded-xl bg-blue-600 border border-blue-400 text-sm font-bold">Male</button>
                <button onclick="setRegGender('female')" id="btn-female" class="flex-1 py-3 rounded-xl bg-slate-700 text-sm font-bold">Female</button>
            </div>
            <input id="reg-phone" type="tel" placeholder="Mobile Number" class="w-full p-4 mb-6 bg-slate-800 rounded-2xl outline-none border border-slate-700">
            <button onclick="saveIdentity()" class="w-full bg-blue-600 py-4 rounded-2xl font-bold shadow-lg">Enter Chat</button>
        </div>
    </div>

    <div id="app-interface">
        <aside class="sidebar-pane border-r border-white/5">
            <div id="profile-area" class="p-6 text-center border-b border-white/5"></div>
            
            <div class="p-4 space-y-2">
                <button onclick="createRoom()" class="w-full bg-blue-600/10 text-blue-400 p-3 rounded-xl text-xs font-black border border-blue-500/20 uppercase tracking-widest">Create Room</button>
                <button onclick="promptJoin()" class="w-full bg-slate-800/40 p-3 rounded-xl text-xs font-black border border-white/5 uppercase tracking-widest">Join Room</button>
            </div>

            <div class="flex-1 overflow-y-auto px-4">
                <p class="text-[10px] font-black text-slate-500 uppercase mb-3 ml-2 tracking-widest">Recent Chats</p>
                <div id="recent-chats" class="space-y-1"></div>
                
                <div class="mt-6 pt-4 border-t border-white/5">
                    <p class="text-[10px] font-black text-slate-500 uppercase mb-2 ml-2">Search ID</p>
                    <div class="flex gap-2 bg-black/20 p-1 rounded-xl border border-white/5">
                        <input id="search-id" type="text" placeholder="SAC-XXXX" class="flex-1 bg-transparent p-2 text-xs outline-none uppercase">
                        <button onclick="searchUniqueId()" class="bg-blue-600 px-4 py-2 text-[10px] rounded-lg font-bold">FIND</button>
                    </div>
                </div>
            </div>
        </aside>

        <main id="chat-pane" class="chat-pane">
            <header class="glass p-3 md:p-4 flex items-center gap-3">
                <button onclick="closeChat()" class="p-2 -ml-2 rounded-full hover:bg-white/5">
                    <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <img id="partner-avatar" src="" class="w-10 h-10 rounded-full bg-slate-800 border border-white/10 hidden">
                <div id="header-text-container" class="hidden">
                    <p id="chat-partner-name" class="font-bold text-sm text-white">Connecting...</p>
                    <p id="chat-status-text" class="text-[9px] text-emerald-400 font-bold uppercase tracking-widest animate-pulse">Waiting for partner...</p>
                </div>
            </header>

            <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-6"></div>

            <div class="p-4 md:p-6">
                <div class="glass flex items-center gap-2 p-1.5 rounded-2xl border border-white/5 shadow-2xl">
                    <input id="msg-input" type="text" placeholder="Type a message..." class="flex-1 bg-transparent px-4 py-2 outline-none text-sm" onkeypress="if(event.key==='Enter') sendMsg()">
                    <button onclick="sendMsg()" class="bg-blue-600 p-3 rounded-xl active:scale-90 transition-all shadow-lg shadow-blue-900/40">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        let peer, conn, selectedGender = 'male';
        let myProfile = JSON.parse(localStorage.getItem('myProfile')) || null;
        let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || {};

        function getAvatar(name, gender) { return `https://api.dicebear.com/7.x/avataaars/svg?seed=${name}&gender=${gender || 'male'}`; }
        
        function setRegGender(g) {
            selectedGender = g;
            document.getElementById('btn-male').className = g === 'male' ? 'flex-1 py-3 rounded-xl bg-blue-600 border border-blue-400 text-sm font-bold' : 'flex-1 py-3 rounded-xl bg-slate-700 text-sm font-bold';
            document.getElementById('btn-female').className = g === 'female' ? 'flex-1 py-3 rounded-xl bg-pink-600 border border-pink-400 text-sm font-bold' : 'flex-1 py-3 rounded-xl bg-slate-700 text-sm font-bold';
        }

        window.onload = () => {
            renderProfileArea();
            peer = new Peer(myProfile ? myProfile.sacId : null);
            
            peer.on('open', (id) => { console.log("My ID:", id); });
            
            // CRITICAL: Handle incoming connections properly
            peer.on('connection', (incomingConn) => {
                conn = incomingConn;
                setupConnectionHandlers();
            });

            renderRecentChats();
            if(!myProfile) document.getElementById('identity-popup').classList.remove('hidden');
        };

        function setupConnectionHandlers() {
            conn.on('open', () => {
                document.getElementById('chat-status-text').innerText = "Online";
                document.getElementById('chat-status-text').classList.remove('animate-pulse');
                if(myProfile) conn.send({type: 'identity', profile: myProfile});
                loadHistory(conn.peer);
            });

            conn.on('data', (data) => {
                if(data.type === 'identity') {
                    chatHistory[conn.peer] = { name: data.profile.name, gender: data.profile.gender, messages: chatHistory[conn.peer]?.messages || [] };
                    updateHeader(data.profile.name, data.profile.gender);
                    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                    renderRecentChats();
                } else if(data.type === 'chat') {
                    appendMessage(data.text, false, chatHistory[conn.peer]?.gender);
                    saveToHistory(conn.peer, null, null, data.text, false);
                }
            });
        }

        function startChat(id) {
            // UI Transition
            document.getElementById('chat-pane').classList.add('active');
            document.getElementById('partner-avatar').classList.remove('hidden');
            document.getElementById('header-text-container').classList.remove('hidden');
            
            // Load Local Data first
            const p = chatHistory[id];
            updateHeader(p?.name || "Searching...", p?.gender || 'male');
            loadHistory(id);

            // Establish Peer Connection
            conn = peer.connect(id);
            setupConnectionHandlers();
        }

        function sendMsg() {
            const val = document.getElementById('msg-input').value.trim();
            if(!val || !conn) return;
            conn.send({type: 'chat', text: val});
            appendMessage(val, true);
            saveToHistory(conn.peer, null, null, val, true);
            document.getElementById('msg-input').value = "";
        }

        function appendMessage(text, isMe, gender = 'male') {
            const container = document.getElementById('messages');
            const wrapper = document.createElement('div');
            wrapper.className = `flex w-full ${isMe ? 'justify-end' : 'justify-start items-end gap-2'}`;
            const avatar = !isMe ? `<img src="${getAvatar('P', gender)}" class="w-7 h-7 rounded-full border border-white/10 shadow-sm">` : '';
            wrapper.innerHTML = `${avatar}<div class="max-w-[75%] px-4 py-2.5 rounded-2xl text-sm ${isMe ? 'bubble-me' : 'bubble-other'} shadow-lg">${text}</div>`;
            container.appendChild(wrapper);
            container.scrollTop = container.scrollHeight;
        }

        function saveToHistory(pid, name, gender, text, isMe) {
            if(!chatHistory[pid]) chatHistory[pid] = { name: name || pid, gender: gender || 'male', messages: [] };
            if(text) chatHistory[pid].messages.push({text, isMe});
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            renderRecentChats();
        }

        function loadHistory(pid) {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            if(chatHistory[pid]) {
                chatHistory[pid].messages.forEach(m => appendMessage(m.text, m.isMe, chatHistory[pid].gender));
            }
        }

        function renderRecentChats() {
            const list = document.getElementById('recent-chats');
            list.innerHTML = '';
            Object.keys(chatHistory).forEach(id => {
                const b = document.createElement('div');
                b.className = "flex items-center gap-3 p-3 hover:bg-white/5 rounded-2xl cursor-pointer transition-all";
                b.innerHTML = `<img src="${getAvatar(chatHistory[id].name, chatHistory[id].gender)}" class="w-10 h-10 rounded-full bg-slate-800">
                               <div class="flex-1 overflow-hidden"><p class="text-sm font-bold text-slate-200 truncate">${chatHistory[id].name}</p>
                               <p class="text-[9px] text-slate-500 font-mono">ID: ${id}</p></div>`;
                b.onclick = () => startChat(id);
                list.appendChild(b);
            });
        }

        function searchUniqueId() {
            const id = document.getElementById('search-id').value.trim().toUpperCase();
            if(id) startChat(id);
        }

        function saveIdentity() {
            const name = document.getElementById('reg-name').value.trim();
            const phone = document.getElementById('reg-phone').value.trim();
            if(!name || !phone) return alert("All fields are required!");
            const randomId = 'SAC-' + Math.floor(1000 + Math.random() * 9000);
            myProfile = { name, phone, gender: selectedGender, sacId: randomId };
            localStorage.setItem('myProfile', JSON.stringify(myProfile));
            location.reload();
        }

        function renderProfileArea() {
            const area = document.getElementById('profile-area');
            if (myProfile) {
                area.innerHTML = `<img src="${getAvatar(myProfile.name, myProfile.gender)}" class="w-16 h-16 mx-auto rounded-full border-2 border-blue-500 mb-2 p-1 bg-slate-800">
                <h3 class="font-bold text-sm text-white">${myProfile.name}</h3><p class="text-[10px] text-slate-500 font-mono mb-2">ID: ${myProfile.sacId}</p>
                <button onclick="navigator.clipboard.writeText('${myProfile.sacId}');alert('ID Copied')" class="text-[9px] bg-white/5 border border-white/10 px-4 py-1.5 rounded-full hover:bg-white/10 uppercase font-bold tracking-widest">Copy My ID</button>`;
            } else {
                area.innerHTML = `<div onclick="document.getElementById('identity-popup').classList.remove('hidden')" class="border-2 border-dashed border-slate-700 p-6 rounded-2xl text-xs font-bold text-slate-500 hover:border-blue-500 cursor-pointer">Register Profile</div>`;
            }
        }

        function updateHeader(name, gender) {
            document.getElementById('chat-partner-name').innerText = name;
            document.getElementById('partner-avatar').src = getAvatar(name, gender);
        }
        function closeChat() { document.getElementById('chat-pane').classList.remove('active'); }
        function createRoom() { const code = Math.random().toString(36).substring(2, 8).toUpperCase(); alert("Your Room Code is: " + code + "\nShare this with your friend!"); startChat(code); }
        function promptJoin() { const code = prompt("Enter the Room Code or SAC-ID:"); if(code) startChat(code.toUpperCase().trim()); }
    </script>
</body>
</html>
