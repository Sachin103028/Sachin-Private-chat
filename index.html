<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sachin's Messenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); }
        #app-interface { display: flex; width: 100vw; height: 100dvh; overflow: hidden; background: #020617; }
        .sidebar-pane { width: 350px; flex-shrink: 0; display: flex; flex-direction: column; border-right: 1px solid rgba(255,255,255,0.05); }
        .chat-pane { flex-grow: 1; display: flex; flex-direction: column; transition: transform 0.4s ease; background: #020617; }

        @media (max-width: 768px) {
            .sidebar-pane { width: 100vw; }
            .chat-pane { position: fixed; inset: 0; width: 100vw; transform: translateX(100%); z-index: 50; visibility: hidden; }
            .chat-pane.active { transform: translateX(0); visibility: visible; }
        }

        .bubble-me { background: #2563eb; color: white; border-radius: 18px 18px 4px 18px; margin-left: auto; }
        .bubble-other { background: #1e293b; color: #f1f5f9; border-radius: 18px 18px 18px 4px; }
    </style>
</head>
<body class="bg-[#020617] text-slate-200 h-screen overflow-hidden">

    <div id="identity-popup" class="hidden fixed inset-0 bg-black/95 flex items-center justify-center z-[100] p-4 backdrop-blur-md">
        <div class="glass p-8 rounded-[32px] w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-6 text-white text-center">Messenger Setup</h2>
            <input id="reg-name" type="text" placeholder="Your Name" class="w-full p-4 mb-4 bg-slate-900 rounded-2xl outline-none border border-slate-800 focus:border-blue-500">
            <button onclick="saveIdentity()" class="w-full bg-blue-600 py-4 rounded-2xl font-bold">Start Chatting</button>
        </div>
    </div>

    <div id="app-interface">
        <aside class="sidebar-pane">
            <div id="profile-area" class="p-6"></div>
            
            <div class="p-4">
                <div class="flex gap-2 bg-slate-900 p-2 rounded-2xl border border-white/5">
                    <input id="global-search" type="text" placeholder="Enter SAC-ID..." class="flex-1 bg-transparent p-2 outline-none uppercase text-sm">
                    <button onclick="searchUser()" class="bg-blue-600 px-4 py-2 rounded-xl text-xs font-bold">SEARCH</button>
                </div>
            </div>

            <div id="recent-chats" class="flex-1 overflow-y-auto px-2">
                <p class="text-[10px] font-black text-slate-500 uppercase p-4 tracking-widest">Recent Chats</p>
            </div>
        </aside>

        <main id="chat-pane" class="chat-pane">
            <header class="glass p-4 flex items-center gap-3">
                <button onclick="closeChat()" class="p-2 md:hidden"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                <div id="header-avatar" class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center font-bold">?</div>
                <div>
                    <p id="chat-partner-name" class="font-bold text-sm">Select User</p>
                    <p id="chat-status" class="text-[10px] text-slate-500 italic">No active connection</p>
                </div>
            </header>

            <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4"></div>

            <div class="p-4 md:p-6 bg-[#020617]">
                <div class="glass flex items-center gap-2 p-2 rounded-3xl">
                    <input id="msg-input" type="text" placeholder="Message..." class="flex-1 bg-transparent px-4 py-2 outline-none text-sm" onkeypress="if(event.key==='Enter') sendMsg()">
                    <button onclick="sendMsg()" class="bg-blue-600 p-3 rounded-full"><svg class="w-5 h-5 text-white transform rotate-90" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg></button>
                </div>
            </div>
        </main>
    </div>

    <script>
        let peer, conn;
        let myProfile = JSON.parse(localStorage.getItem('myProfile'));
        let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || {};

        window.onload = () => {
            if(!myProfile) document.getElementById('identity-popup').classList.remove('hidden');
            else initPeer();
        };

        function saveIdentity() {
            const name = document.getElementById('reg-name').value.trim();
            if(!name) return;
            myProfile = { name, sacId: 'SAC-'+Math.floor(1000+Math.random()*9000) };
            localStorage.setItem('myProfile', JSON.stringify(myProfile));
            location.reload();
        }

        function initPeer() {
            renderProfile();
            renderHistory();
            peer = new Peer(myProfile.sacId);
            
            peer.on('connection', (incoming) => {
                conn = incoming;
                handleConnection();
                openChatUI(conn.peer);
            });

            peer.on('error', (err) => {
                if(err.type === 'peer-not-found') {
                    document.getElementById('chat-status').innerText = "User is currently offline";
                    alert("This ID is not online right now.");
                }
            });
        }

        function searchUser() {
            const id = document.getElementById('global-search').value.trim().toUpperCase();
            if(!id || id === myProfile.sacId) return;

            // Open window immediately so user sees progress
            openChatUI(id);
            document.getElementById('chat-status').innerText = "Trying to connect...";
            
            conn = peer.connect(id);
            handleConnection();
        }

        function handleConnection() {
            conn.on('open', () => {
                document.getElementById('chat-status').innerText = "Online";
                conn.send({ type: 'profile-sync', name: myProfile.name });
            });

            conn.on('data', (data) => {
                if(data.type === 'profile-sync') {
                    chatHistory[conn.peer] = { name: data.name, messages: chatHistory[conn.peer]?.messages || [] };
                    document.getElementById('chat-partner-name').innerText = data.name;
                    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                    renderHistory();
                } else if(data.type === 'chat') {
                    appendMsg(data.content, false);
                    saveMsg(conn.peer, data.content, false);
                }
            });
        }

        function openChatUI(id) {
            document.getElementById('chat-pane').classList.add('active');
            const history = chatHistory[id];
            document.getElementById('chat-partner-name').innerText = history?.name || id;
            document.getElementById('header-avatar').innerText = (history?.name || id).charAt(0);
            
            const container = document.getElementById('messages');
            container.innerHTML = '';
            if(history) history.messages.forEach(m => appendMsg(m.content, m.isMe));
        }

        function sendMsg() {
            const val = document.getElementById('msg-input').value.trim();
            if(!val || !conn || !conn.open) return;
            conn.send({ type: 'chat', content: val });
            appendMsg(val, true);
            saveMsg(conn.peer, val, true);
            document.getElementById('msg-input').value = '';
        }

        function appendMsg(content, isMe) {
            const div = document.createElement('div');
            div.className = `max-w-[80%] p-3 text-sm shadow-lg ${isMe ? 'bubble-me' : 'bubble-other'}`;
            div.innerText = content;
            const container = document.getElementById('messages');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function saveMsg(id, content, isMe) {
            if(!chatHistory[id]) chatHistory[id] = { name: id, messages: [] };
            chatHistory[id].messages.push({ content, isMe });
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('recent-chats');
            list.innerHTML = '<p class="text-[10px] font-black text-slate-500 uppercase p-4 tracking-widest">Recent Chats</p>';
            Object.keys(chatHistory).forEach(id => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-3 p-4 hover:bg-white/5 cursor-pointer";
                div.innerHTML = `<div class="w-10 h-10 rounded-full bg-blue-900 flex items-center justify-center font-bold">${chatHistory[id].name.charAt(0)}</div>
                                 <div><p class="font-bold text-sm">${chatHistory[id].name}</p><p class="text-[10px] text-slate-500">${id}</p></div>`;
                div.onclick = () => { searchUser(id); }; // Re-connect on click
                list.appendChild(div);
            });
        }

        function renderProfile() {
            document.getElementById('profile-area').innerHTML = `
                <div class="flex items-center gap-4 p-4 glass rounded-2xl">
                    <div class="w-12 h-12 rounded-full bg-blue-600 flex items-center justify-center font-bold text-xl">${myProfile.name.charAt(0)}</div>
                    <div><p class="font-bold text-sm">${myProfile.name}</p><p class="text-[10px] text-blue-500 font-bold">${myProfile.sacId}</p></div>
                </div>`;
        }

        function closeChat() { document.getElementById('chat-pane').classList.remove('active'); }
    </script>
</body>
</html>
