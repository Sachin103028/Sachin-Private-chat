<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sachin's World Messenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        .welcome-overlay {
            position: fixed;
            inset: 0;
            background: #0f172a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: opacity 1s ease-out;
        }
        @keyframes pulse-blue {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        .animate-welcome { animation: pulse-blue 2s infinite; }
    </style>
</head>
<body class="bg-slate-900 text-white font-sans overflow-hidden">

    <div id="welcome-screen" class="welcome-overlay">
        <h1 class="text-4xl font-bold text-blue-400 animate-welcome text-center">
            Welcome to<br>Sachin's World
        </h1>
    </div>

    <div id="identity-popup" class="hidden fixed inset-0 bg-slate-950/90 flex items-center justify-center z-50 p-4 backdrop-blur-md">
        <div class="bg-slate-800 p-6 rounded-2xl w-full max-w-sm border border-blue-500 shadow-2xl">
            <div id="reg-step-1">
                <h2 class="text-xl font-bold mb-2">Verify Identity</h2>
                <p id="reg-context" class="text-xs text-slate-400 mb-4">You've been chatting for a minute! Please register to continue.</p>
                <input id="reg-name" type="text" placeholder="Full Name" class="w-full p-3 mb-3 bg-slate-700 rounded-lg border border-slate-600 outline-none">
                <input id="reg-phone" type="tel" placeholder="Phone Number" class="w-full p-3 mb-3 bg-slate-700 rounded-lg border border-slate-600 outline-none">
                <button onclick="sendOTP()" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-lg font-bold transition-all">Send OTP</button>
            </div>

            <div id="reg-step-2" class="hidden">
                <h2 class="text-xl font-bold mb-2">Enter OTP</h2>
                <p class="text-xs text-slate-400 mb-4 text-center">Enter the 4-digit code sent to your phone</p>
                <input id="otp-input" type="text" maxlength="4" placeholder="0 0 0 0" class="w-full p-3 mb-4 bg-slate-700 rounded-lg border border-slate-600 outline-none text-center tracking-[1em] text-xl font-bold">
                
                <div class="flex items-center gap-2 mb-4 bg-slate-900/50 p-3 rounded-lg">
                    <input type="checkbox" id="show-phone" checked class="w-5 h-5 accent-blue-600">
                    <label for="show-phone" id="label-share-name" class="text-xs text-slate-300 font-medium">
                        Show your number to partner
                    </label>
                </div>
                
                <button onclick="verifyAndSave()" class="w-full bg-emerald-600 hover:bg-emerald-500 py-3 rounded-lg font-bold transition-all">Verify & Create SAC-ID</button>
            </div>
        </div>
    </div>

    <div id="setup-screen" class="hidden flex flex-col items-center justify-center min-h-screen p-4">
        <div class="bg-slate-800 p-8 rounded-3xl shadow-2xl border border-slate-700 w-full max-w-sm">
            <h1 class="text-2xl font-bold text-center mb-6 text-blue-400">ðŸ”’ Private Chat</h1>
            
            <button onclick="createRoom()" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-bold transition-all mb-4 shadow-lg shadow-blue-900/20">
                Create New Room
            </button>
            
            <div class="relative mb-4">
                <input id="room-input" type="text" placeholder="Enter 6-digit code" 
                    class="w-full p-4 rounded-xl bg-slate-700 border border-slate-600 focus:border-blue-500 outline-none text-center tracking-widest font-mono">
            </div>
            
            <button onclick="joinRoom()" class="w-full bg-slate-700 hover:bg-slate-600 py-4 rounded-xl font-bold transition-all">
                Join Room
            </button>

            <div class="flex items-center my-8">
                <hr class="flex-grow border-slate-700">
                <span class="px-4 text-slate-500 text-[10px] font-black tracking-widest">ADVANCED</span>
                <hr class="flex-grow border-slate-700">
            </div>

            <div class="space-y-4">
                <div class="flex gap-2">
                    <input id="search-id" type="text" placeholder="SAC-XXXX" class="flex-1 p-3 rounded-xl bg-slate-900 border border-slate-700 outline-none text-sm font-mono">
                    <button onclick="handleAdvancedAction('search')" class="bg-blue-600 hover:bg-blue-500 px-4 rounded-xl text-sm font-bold">Search</button>
                </div>
                
                <div id="recent-section" class="hidden mt-4">
                    <p class="text-[10px] font-black text-slate-500 mb-2 uppercase tracking-widest">Recent Chats</p>
                    <div id="recent-chats" class="space-y-2 max-h-32 overflow-y-auto pr-2"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="chat-screen" class="hidden flex flex-col h-screen max-w-2xl mx-auto bg-slate-800">
        <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/80 backdrop-blur-lg">
            <div>
                <p id="chat-partner-name" class="font-bold text-blue-400">Chatting...</p>
                <p id="chat-partner-info" class="text-[10px] text-slate-500 font-mono"></p>
            </div>
            <button onclick="location.reload()" class="text-xs bg-slate-700 px-3 py-2 rounded-lg font-bold">Exit</button>
        </div>
        <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-900/30"></div>
        <div class="p-4 bg-slate-900/80">
            <div class="flex gap-2 bg-slate-700 p-2 rounded-2xl border border-slate-600">
                <input id="msg-input" type="text" placeholder="Type message..." class="flex-1 bg-transparent px-3 outline-none">
                <button onclick="sendMsg()" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-xl font-bold transition-all">Send</button>
            </div>
        </div>
    </div>

    <script>
        let peer, conn, chatTimer;
        let myProfile = JSON.parse(localStorage.getItem('myProfile')) || null;
        let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || {};
        let activePeerId = null;
        let partnerName = "A";

        // Welcome Voice Logic
        window.onload = () => {
            const speak = () => {
                const msg = new SpeechSynthesisUtterance("Welcome to Sachin's world");
                const voices = window.speechSynthesis.getVoices();
                msg.voice = voices.find(v => v.name.includes('Female') || v.name.includes('Google UK English Female') || v.name.includes('Samantha')) || voices[0];
                msg.pitch = 1.1;
                window.speechSynthesis.speak(msg);
            };
            if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = speak; else speak();

            setTimeout(() => {
                document.getElementById('welcome-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('welcome-screen').classList.add('hidden');
                    document.getElementById('setup-screen').classList.remove('hidden');
                    initPeer();
                    if(myProfile) showRegisteredUI();
                }, 1000);
            }, 2500);
        };

        function initPeer() {
            const myId = myProfile ? localStorage.getItem('myUniqueId') : null;
            peer = myId ? new Peer(myId) : new Peer();
            peer.on('connection', (c) => { conn = c; setupConnection(); });
        }

        function handleAdvancedAction(type) {
            if (!myProfile) {
                document.getElementById('reg-context').innerText = `Registration required for ${type}.`;
                document.getElementById('identity-popup').classList.remove('hidden');
            } else if (type === 'search') {
                joinBySearch();
            }
        }

        // OTP Simulation
        function sendOTP() {
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            if(!name || !phone) return alert("Fill all fields");
            
            const mockOTP = Math.floor(1000 + Math.random() * 9000);
            console.log("DEBUG: Your OTP is " + mockOTP);
            alert("Verification code sent to " + phone + "\n(Check console/alert for demo: " + mockOTP + ")");
            window.currentOTP = mockOTP.toString();
            
            document.getElementById('reg-step-1').classList.add('hidden');
            document.getElementById('reg-step-2').classList.remove('hidden');
            document.getElementById('label-share-name').innerText = `Show your number to ${partnerName}`;
        }

        function verifyAndSave() {
            const entered = document.getElementById('otp-input').value;
            if(entered !== window.currentOTP) return alert("Invalid OTP");

            const sacId = 'SAC-' + Math.floor(1000 + Math.random() * 9000);
            myProfile = {
                name: document.getElementById('reg-name').value,
                phone: document.getElementById('reg-phone').value,
                show: document.getElementById('show-phone').checked,
                sacId: sacId
            };
            
            localStorage.setItem('myProfile', JSON.stringify(myProfile));
            localStorage.setItem('myUniqueId', sacId);
            location.reload();
        }

        function startChatTimer() {
            if (myProfile) return;
            chatTimer = setTimeout(() => {
                if (!myProfile) {
                    document.getElementById('reg-context').innerText = `You've been chatting with ${partnerName} for a minute. Complete registration to continue.`;
                    document.getElementById('identity-popup').classList.remove('hidden');
                }
            }, 60000);
        }

        function setupConnection() {
            conn.on('open', () => {
                document.getElementById('setup-screen').classList.add('hidden');
                document.getElementById('chat-screen').classList.remove('hidden');
                if(myProfile) conn.send({type: 'identity', profile: myProfile});
                startChatTimer();
                loadHistory(conn.peer);
            });

            conn.on('data', (data) => {
                if(data.type === 'identity') {
                    partnerName = data.profile.name;
                    document.getElementById('chat-partner-name').innerText = partnerName;
                    document.getElementById('chat-partner-info').innerText = data.profile.show ? data.profile.phone : "Contact Hidden";
                    saveToHistory(conn.peer, partnerName, null, false);
                } else {
                    appendMessage(data.text, 'other');
                    saveToHistory(conn.peer, null, data.text, false);
                }
            });
        }

        // UI Handlers
        function createRoom() {
            const code = Math.random().toString(36).substring(2, 8).toUpperCase();
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('chat-screen').classList.remove('hidden');
            document.getElementById('chat-partner-name').innerText = "Waiting...";
            document.getElementById('chat-partner-info').innerText = "Share: " + (myProfile?.sacId || peer.id);
            startChatTimer();
        }

        function joinRoom() {
            const code = document.getElementById('room-input').value.toUpperCase();
            if(code) { conn = peer.connect(code); setupConnection(); }
        }

        function joinBySearch() {
            const id = document.getElementById('search-id').value.toUpperCase();
            if(id.startsWith('SAC-')) { conn = peer.connect(id); setupConnection(); }
        }

        function sendMsg() {
            const val = document.getElementById('msg-input').value;
            if(!val || !conn) return;
            conn.send({type: 'chat', text: val});
            appendMessage(val, 'me');
            saveToHistory(conn.peer, null, val, true);
            document.getElementById('msg-input').value = "";
        }

        function showRegisteredUI() {
            document.getElementById('recent-section').classList.remove('hidden');
            renderRecentChats();
        }

        function saveToHistory(pid, name, text, isMe) {
            if(!myProfile) return;
            if(!chatHistory[pid]) chatHistory[pid] = { name: name || pid, messages: [] };
            if(name) chatHistory[pid].name = name;
            if(text) chatHistory[pid].messages.push({text, isMe});
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            renderRecentChats();
        }

        function loadHistory(pid) {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            if(chatHistory[pid]) {
                document.getElementById('chat-partner-name').innerText = chatHistory[pid].name;
                chatHistory[pid].messages.forEach(m => appendMessage(m.text, m.isMe ? 'me' : 'other'));
            }
        }

        function renderRecentChats() {
            const list = document.getElementById('recent-chats');
            list.innerHTML = '';
            Object.keys(chatHistory).forEach(id => {
                const b = document.createElement('div');
                b.className = "p-2 bg-slate-900/50 rounded-lg border border-slate-700 flex justify-between cursor-pointer hover:bg-slate-700";
                b.innerHTML = `<span class='text-xs font-bold'>${chatHistory[id].name}</span><span class='text-[10px] opacity-50'>${id}</span>`;
                b.onclick = () => { document.getElementById('search-id').value = id; handleAdvancedAction('search'); };
                list.appendChild(b);
            });
        }

        function appendMessage(text, sender) {
            const container = document.getElementById('messages');
            const wrapper = document.createElement('div');
            wrapper.className = `flex ${sender === 'me' ? 'justify-end' : 'justify-start'}`;
            const m = document.createElement('div');
            m.className = `max-w-[80%] px-4 py-2 rounded-2xl ${sender === 'me' ? 'bg-blue-600 rounded-tr-none' : 'bg-slate-700 rounded-tl-none'}`;
            m.innerText = text;
            wrapper.appendChild(m);
            container.appendChild(wrapper);
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>
